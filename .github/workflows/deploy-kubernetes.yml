name: Deploy to Kubernetes

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  REGISTRY: docker.io
  IMAGE_NAME_APP: tggrid/main-app
  IMAGE_NAME_POOL: tggrid/browser-pool
  IMAGE_NAME_WS: tggrid/websocket-service

jobs:
  build-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
    
    - name: Install Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest
    
    - name: Install dependencies
      run: bun install
    
    - name: Run linting
      run: bun run lint --fix
    
    - name: Run tests
      run: bun test
    
    - name: Build application
      run: bun run build

  build-docker:
    needs: build-test
    runs-on: ubuntu-latest
    if: github.event_name == 'push'
    
    strategy:
      matrix:
        include:
          - dockerfile: ./Dockerfile
            image-name: main-app
            context: .
          - dockerfile: ./mini-services/browser-pool/Dockerfile
            image-name: browser-pool
            context: ./mini-services/browser-pool
          - dockerfile: ./mini-services/browser-websocket/Dockerfile
            image-name: websocket-service
            context: ./mini-services/browser-websocket
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}
    
    - name: Build and push Docker image
      uses: docker/build-push-action@v4
      with:
        context: ${{ matrix.context }}
        file: ${{ matrix.dockerfile }}
        push: true
        tags: |
          ${{ secrets.DOCKER_USERNAME }}/tggrid/${{ matrix.image-name }}:${{ github.sha }}
          ${{ secrets.DOCKER_USERNAME }}/tggrid/${{ matrix.image-name }}:latest
        cache-from: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/tggrid/${{ matrix.image-name }}:buildcache
        cache-to: type=registry,ref=${{ secrets.DOCKER_USERNAME }}/tggrid/${{ matrix.image-name }}:buildcache,mode=max

  deploy-digitalocean:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install doctl
      uses: digitalocean/action-doctl@v2
      with:
        token: ${{ secrets.DIGITALOCEAN_ACCESS_TOKEN }}
    
    - name: Get kubeconfig
      run: doctl kubernetes cluster kubeconfig save tggrid-cluster
    
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Install Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/
    
    - name: Create namespace and secrets
      run: |
        kubectl create namespace tggrid --dry-run=client -o yaml | kubectl apply -f -
        kubectl delete secret docker-secret -n tggrid --ignore-not-found
        kubectl create secret docker-registry docker-secret \
          --docker-server=registry.digitalocean.com \
          --docker-username=${{ secrets.DOCKER_USERNAME }} \
          --docker-password=${{ secrets.DOCKER_PASSWORD }} \
          -n tggrid
    
    - name: Update image tags
      run: |
        sed -i 's/tggrid\/main-app:latest/${{ secrets.DOCKER_USERNAME }}\/tggrid\/main-app:${{ github.sha }}/g' \
          k8s/overlays/digitalocean/kustomization.yaml
        sed -i 's/tggrid\/browser-pool:latest/${{ secrets.DOCKER_USERNAME }}\/tggrid\/browser-pool:${{ github.sha }}/g' \
          k8s/overlays/digitalocean/kustomization.yaml
        sed -i 's/tggrid\/websocket-service:latest/${{ secrets.DOCKER_USERNAME }}\/tggrid\/websocket-service:${{ github.sha }}/g' \
          k8s/overlays/digitalocean/kustomization.yaml
    
    - name: Deploy with Kustomize
      run: kustomize build k8s/overlays/digitalocean | kubectl apply -f -
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/tggrid-app -n tggrid --timeout=5m
        kubectl rollout status deployment/browser-pool -n tggrid --timeout=5m
    
    - name: Verify deployment
      run: kubectl get all -n tggrid

  deploy-gke:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        service_account_key: ${{ secrets.GCP_SERVICE_ACCOUNT_KEY }}
        export_default_credentials: true
    
    - name: Get GKE credentials
      run: |
        gcloud container clusters get-credentials tggrid-cluster \
          --region us-central1 \
          --project ${{ secrets.GCP_PROJECT_ID }}
    
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Install Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/
    
    - name: Configure Docker for GCR
      run: gcloud auth configure-docker
    
    - name: Create namespace and secrets
      run: |
        kubectl create namespace tggrid --dry-run=client -o yaml | kubectl apply -f -
        kubectl delete secret docker-secret -n tggrid --ignore-not-found
        kubectl create secret docker-registry docker-secret \
          --docker-server=gcr.io \
          --docker-username=_json_key \
          --docker-password="$(cat $GOOGLE_APPLICATION_CREDENTIALS)" \
          -n tggrid
    
    - name: Update image tags
      run: |
        GCR_REGISTRY="gcr.io/${{ secrets.GCP_PROJECT_ID }}"
        sed -i "s|gcr.io/YOUR_PROJECT_ID|$GCR_REGISTRY|g" k8s/overlays/gke/kustomization.yaml
        sed -i "s/:latest/:${{ github.sha }}/g" k8s/overlays/gke/kustomization.yaml
    
    - name: Deploy with Kustomize
      run: kustomize build k8s/overlays/gke | kubectl apply -f -
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/tggrid-app -n tggrid --timeout=5m
        kubectl rollout status deployment/browser-pool -n tggrid --timeout=5m
    
    - name: Verify deployment
      run: kubectl get all -n tggrid

  deploy-eks:
    needs: build-docker
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Get EKS kubeconfig
      run: |
        aws eks update-kubeconfig \
          --name tggrid-cluster \
          --region us-east-1
    
    - name: Install kubectl
      uses: azure/setup-kubectl@v3
    
    - name: Install Kustomize
      run: |
        curl -s "https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh" | bash
        sudo mv kustomize /usr/local/bin/
    
    - name: Configure ECR credentials
      run: |
        aws ecr get-login-password --region us-east-1 | \
          docker login --username AWS --password-stdin \
          ${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com
    
    - name: Create namespace and secrets
      run: |
        kubectl create namespace tggrid --dry-run=client -o yaml | kubectl apply -f -
        kubectl delete secret docker-secret -n tggrid --ignore-not-found
        kubectl create secret docker-registry docker-secret \
          --docker-server=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com \
          --docker-username=AWS \
          --docker-password=$(aws ecr get-login-password --region us-east-1) \
          -n tggrid
    
    - name: Update image tags
      run: |
        ECR_REGISTRY="${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.us-east-1.amazonaws.com"
        sed -i "s|YOUR_AWS_ACCOUNT_ID|${{ secrets.AWS_ACCOUNT_ID }}|g" k8s/overlays/aws/kustomization.yaml
        sed -i "s/:latest/:${{ github.sha }}/g" k8s/overlays/aws/kustomization.yaml
    
    - name: Deploy with Kustomize
      run: kustomize build k8s/overlays/aws | kubectl apply -f -
    
    - name: Wait for rollout
      run: |
        kubectl rollout status deployment/tggrid-app -n tggrid --timeout=5m
        kubectl rollout status deployment/browser-pool -n tggrid --timeout=5m
    
    - name: Verify deployment
      run: kubectl get all -n tggrid

  notify-deployment:
    needs: [deploy-digitalocean, deploy-gke, deploy-eks]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Notify Slack on Success
      if: needs.deploy-digitalocean.result == 'success' && needs.deploy-gke.result == 'success' && needs.deploy-eks.result == 'success'
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "✅ TGGrid deployment successful",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "✅ *TGGrid Deployment Successful*\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref }}\n*Environments:* DigitalOcean, GKE, AWS"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
    
    - name: Notify Slack on Failure
      if: needs.deploy-digitalocean.result == 'failure' || needs.deploy-gke.result == 'failure' || needs.deploy-eks.result == 'failure'
      uses: slackapi/slack-github-action@v1
      with:
        payload: |
          {
            "text": "❌ TGGrid deployment failed",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "❌ *TGGrid Deployment Failed*\n*Commit:* ${{ github.sha }}\n*Branch:* ${{ github.ref }}"
                }
              }
            ]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
